#!/bin/bash
# –°–∫—Ä–∏–ø—Ç –¥–ª—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞ VPS —Å–µ—Ä–≤–µ—Ä–∞

set -e

echo "üîß –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ —Ç—Ä–∞—Ñ–∏–∫–∞..."

# 1. –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º vnstat –¥–ª—è —Ç–æ—á–Ω–æ–≥–æ –ø–æ–¥—Å—á–µ—Ç–∞ —Ç—Ä–∞—Ñ–∏–∫–∞
echo "üì¶ –£—Å—Ç–∞–Ω–æ–≤–∫–∞ vnstat..."
apt-get update -qq
apt-get install -y vnstat

# 2. –ó–∞–ø—É—Å–∫–∞–µ–º vnstat –∏ —Å–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
echo "üóÑ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è vnstat..."
systemctl enable vnstat
systemctl start vnstat

# –û–ø—Ä–µ–¥–µ–ª—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
INTERFACE=$(ip route | grep default | awk '{print $5}' | head -1)
echo "üåê –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å: $INTERFACE"

# –°–æ–∑–¥–∞–µ–º –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –µ—Å–ª–∏ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if ! vnstat -i "$INTERFACE" --json > /dev/null 2>&1; then
    vnstat --add -i "$INTERFACE"
    echo "‚úÖ –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö vnstat —Å–æ–∑–¥–∞–Ω–∞ –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ $INTERFACE"
fi

# 3. –î–µ–ª–∞–µ–º —Å–∫—Ä–∏–ø—Ç –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ –∏—Å–ø–æ–ª–Ω—è–µ–º—ã–º
chmod +x /root/bot/monitor_traffic.py

# 4. –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º cron –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤
echo "‚è∞ –ù–∞—Å—Ç—Ä–æ–π–∫–∞ cron –∑–∞–¥–∞—á–∏..."

# –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—É—é –∑–∞–¥–∞—á—É –µ—Å–ª–∏ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
crontab -l 2>/dev/null | grep -v "monitor_traffic.py" | crontab - || true

# –î–æ–±–∞–≤–ª—è–µ–º –Ω–æ–≤—É—é –∑–∞–¥–∞—á—É (–∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤)
(crontab -l 2>/dev/null; echo "0 */6 * * * cd /root/bot && /usr/bin/python3 /root/bot/monitor_traffic.py >> /var/log/traffic_monitor.log 2>&1") | crontab -

echo "‚úÖ Cron –∑–∞–¥–∞—á–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∞: –ø—Ä–æ–≤–µ—Ä–∫–∞ –∫–∞–∂–¥—ã–µ 6 —á–∞—Å–æ–≤"

# 5. –°–æ–∑–¥–∞–µ–º –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –¥–ª—è –ª–æ–≥–æ–≤
mkdir -p /var/lib/freedomvpn
touch /var/log/traffic_monitor.log

echo ""
echo "‚úÖ –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥ —Ç—Ä–∞—Ñ–∏–∫–∞ –Ω–∞—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!"
echo ""
echo "üìä –¢–µ–∫—É—â–∞—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —Ç—Ä–∞—Ñ–∏–∫–∞:"
vnstat -i "$INTERFACE"
echo ""
echo "üß™ –¢–µ—Å—Ç–æ–≤—ã–π –∑–∞–ø—É—Å–∫ –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞..."
cd /root/bot && /usr/bin/python3 /root/bot/monitor_traffic.py
echo ""
echo "‚úÖ –ì–æ—Ç–æ–≤–æ! –í—ã –±—É–¥–µ—Ç–µ –ø–æ–ª—É—á–∞—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –ø—Ä–∏:"
echo "   ‚Ä¢ 50% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (500 GB)"
echo "   ‚Ä¢ 75% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (750 GB)"
echo "   ‚Ä¢ 90% –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è (900 GB)"
echo ""
echo "üìã –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è:"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫: vnstat"
echo "   ‚Ä¢ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç–∞—Ç—É—Å: crontab -l | grep monitor_traffic"
echo "   ‚Ä¢ –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –ª–æ–≥–∏: tail -f /var/log/traffic_monitor.log"
echo "   ‚Ä¢ –°–±—Ä–æ—Å–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: rm /var/lib/freedomvpn/traffic_alert_state.json"
